# 介绍

网格参数化算法通俗的说就是将计算机中的三维网格曲面“展平”到二维平面上，生活中常见的“展平”的案例包括：地球仪的展平与汽车贴膜等，在游戏工业中将原始曲面展到平面上，美术再对展平的图形贴上色彩纹理或者是细微凹凸的高频信息这个过程称之为纹理映射(Texture Mapping)

<img src="https://lgximgs.oss-cn-beijing.aliyuncs.com/application.png" alt="application" style="zoom: 67%;" />

由于在计算机中渲染管线最终是对三角形进行渲染，所以上面“展平”的过程也就是求解这样的一个映射$f :M \to M'$,将原来嵌入在$R^3$中的三角网格M映射到一个嵌入在$R^2$中的三角网格M'

![param_intro](https://lgximgs.oss-cn-beijing.aliyuncs.com/param_intro.png)

这个映射不是平凡的(Non-Trivial)（在某些2.5D的场景下可以是平凡的，只要将z值设为0即可），需要满足以下的一些约束，而求解这样一个映射的算法就是三角网格参数化算法。

。。。。

由于网格可以认为是一个图，所以可以借助图论的方法来进行一个求解，图论中可平面图的理论

## 基础算法

### LSCM（Least Square Conformal Mesh）算法

映射$f$是一个分段线性映射，对每个三角形是一个常量可以表示成$$ f_t(x) = J_tx +b_t $$,x是顶点三维坐标，不过我们可以通过建立一个如下的局部坐标系只使用二维就能表示

![](https://lgximgs.oss-cn-beijing.aliyuncs.com/2741947-20231212203836222-1326788253.png)


映射的Jacobi矩阵$J_t$是一个2*2矩阵
$$
J_t = {\begin{pmatrix}{{\partial u}/{\partial x}}&{{\partial u}/{\partial y}}\\{{\partial v}/{\partial x}}&{{\partial v}/{\partial y}}\end{pmatrix} }
$$
容易计算得到
$$
J_t = {\begin{pmatrix}{u_j-u_i}&{u_k-u_i}\\{v_j-u_i}&{v_k-v_i}\end{pmatrix} }{\begin{pmatrix}{x_j-x_i}&{x_k-x_i}\\{y_j-y_i}&{y_k-y_i}\end{pmatrix}^{-1}}
$$
将上式展开整理
$$
{\begin{pmatrix}{{\partial u}/{\partial x}}\\{{\partial u}/{\partial y}}\end{pmatrix} }=\frac{1}{2A_t}{\begin{pmatrix}{y_j-y_k}&{y_k-y_i}&{y_i-y_j}\\{x_k-x_j}&{x_i-x_k}&{x_j-x_i}\end{pmatrix} }
{\begin{pmatrix}u_i\\u_j\\u_k\end{pmatrix} }
$$
其中$A_t$是三角形面积，可以通过叉积求得$2A_t=(x_iy_j-y_ix_j)+(x_jy_k-y_jx_k)+(x_ky_i-y_kx_i)$

用复数来表示则可得
$$
{\partial u}/{\partial x} + i{\partial u}/{\partial y} = \frac{i}{2A_t}(W_{t_i},W_{t_j},W_{t_k}){\begin{pmatrix}u_i\\u_j\\u_k\end{pmatrix}}\\
其中\begin{cases}W_{t_i} = (x_k - x_j)+i(y_k-y_j)\\
W_{t_j} = (x_i - x_k)+i(y_i-y_k)\\
W_{t_k} = (x_j - x_i)+i(y_j-y_i)\\
\end{cases}
$$
共形映射即是全纯映射（无退化点），所以是满足Cauchy-Rieman定理的
$$
C.R.\begin{cases}{{\partial u}/{\partial x}} = {{\partial v}/{\partial y}}\\
{{\partial u}/{\partial y}} = {-{\partial v}/{\partial x}}\end{cases}\\
令 U = u+iv,则上式统一为
{{\partial U}/{\partial x}}+i{{\partial U}/{\partial y}}=0\\
$$
同时有
$$
{{\partial U}/{\partial x}}+i{{\partial U}/{\partial y}}=\frac{i}{2A_t}(W_{t_i},W_{t_j},W_{t_k}){\begin{pmatrix}U_i\\U_j\\U_k\end{pmatrix}}\\
$$
那样这个三角形的保角(共形)的度量可以表示为
$$
C(U)_t  = {||{{\partial U}/{\partial x}}+i{{\partial U}/{\partial y}}||}^2_t
$$
而整个三角网格映射的能量
$$
E_{lscm} = \Sigma_{t\in T} {||{{\partial U}/{\partial x}}+i{{\partial U}/{\partial y}}||}^2_t
$$

$$
E_{lscm} = C(U=(U1,...,Un)^T) = \Sigma_{i=1}^{n} C(T_i) \\
C(T_i) = {||{{\partial U}/{\partial x}}+i{{\partial U}/{\partial y}}||}^2 A_{T_j}=\frac {1} {4A_T}{|(W_{j1},W_{j2},W_{j3})(U_{j1},U_{j2},U_{j3})|}^2\\
$$

上面推导的总体能量是关于复数$U1,U2...,Un$的二次型所以可以表示成
$$
E_{lscm} = C(U=(U_1,U_2,...,U_n))=U^*CU
$$
由$C$的构造其为$Hermittan\ Gram$矩阵,所以$C$可以分解为
$$
C=M^*M\\
M=(m_{ij})是F\times V稀疏矩阵，行对应三角面，列对应顶点，其系数\\
m_ij = \begin{cases}W_{j,T_i},如果v_j属于三角形T_i \\ 0\end{cases}
$$
上面的能量优化容易得到一个平凡解（trivial），即像为0的常映射（U恒为0），为得到非平凡解可以固定一部分点(pin点)，对M,U分块则能量式可以写为
$$
C(U) = ||MU||^2=||MfUf+MpUp||^2
$$
复矩阵$M$的实部与虚部进行分解$M=M^{re}+iM^{im}$,那么可以将上式转为求解如下的实最小二乘
$$
C(x) = ||Ax-b||^2\\
A={\begin{pmatrix}{M_f^{Re}}&{-M_f^{Im}}\\{M_f^{Im}}&{-M_f^{Re}}\end{pmatrix} },
b=-{\begin{pmatrix}{M_p^{Re}}&{-M_p^{Im}}\\{M_p^{Re}}&{-M_p^{Im}}\end{pmatrix} }{\begin{pmatrix}U_p^{Re}\\U_p^{Im}\end{pmatrix}}
$$
其中矩阵A的大小为$2|F|\times 2(|V| -p)$，并且$b\in R^{2|F|},x\in R^{2|V|-p}$ 

原始文章附录中证明了,当固定点个数大于等于2时($p\geq2$)，矩阵A满秩，最小化问题有唯一解$x=(A^TA)^{-1}A^Tb$

### ARAP(As Rigid As Possible)算法

果想要得到共形映射，那么映射f的Jacobi矩阵应该是相似矩阵即奇异值$\sigma1 = \sigma2$。对于这样的相似矩阵可以构造一个相似矩阵族$\Omega_s$,那样度量Jacobi矩阵与相似矩阵族$\Omega_s$的差异（距离)。$min\{J_t-L_t\} ,L_t\in\Omega_s$,而对于整个三角网格，那么可以得到一个如下的能量函数，而关键就是如何对这个能量进行优化

$$
E=\sum_{t}A_t||J_t-L_t||_F^2,L_t\in\Omega_s \ 
$$

根据[2]中的证明，可以将上面的能量转化为如下形式

$$
E(u,L) = \frac{1}{2}\sum_{t=1}^T\sum_{i=0}^2cot(\theta_t^i)||(u_t^i-u_t^{i+1})-L_t(x_t^i-x_t^{i+1})||^2\\
其中\theta_i是三角形f_t中 (x_i , x_{i+1} ) 对应的三角形
$$


式子中的变量有两部分，其一是要优化的映射Jacobi矩阵，其二是局部优化目标。这样优化过程可以考虑分为两步进行固定其中一个优化另外一个，并迭代进行。

![image-20231212222109714](/Users/liguoxiong/Desktop/参数化文章/未命名文件夹/image-20231212222109714.png)

首先固定$J_t$优化$L_t$。考虑

$$
d(J_t,L_t)=||J_t-L_t||_F^2=tr((J_t-L_t)^T(J_t-L_t))
$$
参考[3]根据Procrustes分析，可以通过对$J_t$的带符号的SVD分解(Signed SVD)来最小化$d(J_t,L_t)$

带符号的SVD分解如下：

$$
J_t=U\Sigma V^T,\Sigma={\begin{pmatrix}{\sigma_1}&{0}\\{0}&{\sigma_2}\end{pmatrix} }
$$
其中U,V保证是旋转矩阵，可以令$\sigma_2$是负的(一般的SVD分解中U,V是正交矩阵不一定是旋转矩阵)

那么可以得到$L_t$的优化解为

$$
L_t = U {\begin{pmatrix}{s}&{0}\\{0}&{s}\end{pmatrix}} V^T,s = \frac{\sigma_1+\sigma_2}{2}
$$
这个局部优化的效果可参看下图，其中右边黑色三角形是优化的目标三角形，红色三角形为最优的共形三角形

![image-20231212222558721](/Users/liguoxiong/Desktop/参数化文章/未命名文件夹/image-20231212222558721.png)

得到了$\{L_t\}$后接下来对$J_t$进行优化

$$
\begin{aligned}

E(u,L) = \frac{1}{2}\sum_{t=1}^T\sum_{i=0}^2cot(\theta_t^i)||(u_t^i-u_t^{i+1})-L_t(x_t^i-x_t^{i+1})||^2 \\

=\frac{1}{2}\sum_{(i,j)\in he}cot(\theta_{ij})||(u_t^i-u_t^{i+1})-L_t(x_t^i-x_t^{i+1})||^2

\end{aligned}
$$

我们优化的变量是$\{u_t\}$,其中he代表该三角网格的半边结构

上式对未知量$\{u_t\}$求导并设导数(梯度)为0，可以得到

$$
\sum_{(i,j)\in he}cot(\theta_{ij})||(u_t^i-u_t^{i+1})-L_t(x_t^i-x_t^{i+1})||^2 =\sum_{(i,j)\in he}cot(\theta_{ij})||(u_t^i-u_t^{i+1})-L_t(x_t^i-x_t^{i+1})||^2
$$
这样也就可以通过求解稀疏线性方程组来求得$\{u_t\}$

P.S. [1]中附录部分也证明了(2)式等价于$E= \sum_{t=1}^TA_t(\sigma_{1,t}-\sigma_{2,t})^2$，而这等价于LSCM方法优化的能量

[1] Ligang Liu , A Local/Global Approach to Mesh Parameterization 2008

[2] PINKALL U., POLTHIER K.: Computing discrete mini- mal surface and their conjugates. Experimental Mathematics 2, 1(1993),15–36. 2,3

[3] GOWER J. C., DIJKSTERHUIS G. B.: Procrustes Prob- lems. Oxford University Press, 2004. 4

### ABF（Angle Based Flattening）算法

首先要知道的是映射f可以由展开后(二维)的三角网格内角唯一确定的，这个观察为我们提供了一个新的角度，可以考虑将网格三角形的角度作为优化对象。对于保角（共形）参数化，直观的看就是尽可能保持三角网格内角大小保持不变,设$\alpha_i$为三角网格展开后的内角值。则可以转为如下二次优化问题

求 $Q=min\Sigma(\alpha_i - \alpha_i^0)^2$约束：

(1)三角形内角和为$\pi$, $\Sigma_{\alpha_i\in t}{\alpha_i}=\pi$ 

(2)对于内部每个顶点v，其1-邻域角度和为$2\pi$,$\Sigma_{\alpha_i\in v}=2\pi$

(3)对于每个顶点v,其1-邻域两个对角$\beta_i与\gamma_i$满足如下关系$\prod \frac {sin_{\beta_i}} {sin\gamma_i}=1$

上面约束优化问题可以用Lagrange乘子法转化为无约束优化问题进行求解，但是会比较复杂，而的linABF对其进行线性化从而



## 基于共形因子的参数化算法

在连续微分几何中，二维流形M的两个黎曼度量g与$g^~被称为是共形等价的（conformal equivalent）如果他们满足如下关系：（公式）

其中u：M->R,是一个定义在M上的实值函数，其是度量的放缩因子称为共形因子。

在离散情况下可以认为三角网格M(V,E,T),其度量可以定义为定义在边集E的函数，每条边都赋予一个正值。而u可以定义在M的顶点集V上。

这样对于M的两个度量l与l(也就是两组边长),如果是共形等价的，那么他们可以满足下式l~=e(ui+uj)/2*l。

对于一个离散曲面M可以抽象定义为(V,E,T),V为其点集，E为其边集，T为三角连接关系，M如果嵌入到三维空间R3中则为其点集V中的每个点赋予了一个R3的一个值。

而参数化就可以表述为是已知M在R3上的一个嵌入，求其在R2上的嵌入。

而M的一个离散度量可以为边集中的元素赋予一个正值。通过定义度量可以诱导出M中各三角形的角度值，从而诱导出离散高斯曲率。

共形因子改变黎曼度量，而黎曼度量改变了高斯曲率，其变化关系遵循如下的yamabe方程 .

从而一个很自然的想法就是通过求解yamabe方程



CPMS：

这里暂时只讨论拓扑同胚于圆盘的三角网格如何进行参数化使其扭曲达到最小。

根据经典的微分几何理论（连续的曲面）任何拓扑同胚于圆盘的曲面总能共形映射到单位圆盘。

如何变换就是通过改变曲面的度量。而对于离散情况下的三角网格，度量就可以理解为曲面的边

对于三角网格，度量可以定义为曲面上顶点的一个映射 u:V->R。

那么可以证明如果两个度量之间是共形等价的，需要满足如下关系：

共形因子与高斯曲率的关系遵循如下的yamabe方程。对于离散的三角形网格，可以简化成以下（线性）泊松方程（证明可以参见【1】的appendix）

对于共形曲面参数化，上面的目标曲率可以如下定义：

如果有了共形因子，可以通过如下公式得到边的缩放系数，得到曲面参数化后的边长，然后通过BFS可以求得曲面的参数化坐标（UV）坐标。

BFF:



在经典的微分几何中，有如下的Rieman映射定理：

Circle Pattern:

对于曲面间的共形映射，共形可以通过如下方式来解释：对于每个点其周边的圆域映射到曲面的圆域中。也就是每个点的小圆盘映射到一个同样的一个小圆盘中。这样就可以得到一种逼近共形映射的方式：通过保持三角网格圆盘的一致性。

首先想到的自然是每个顶点赋予一个圆盘，通过映射保持每个点的圆盘，从而逼近一个共形映射。但是这个方法只考虑到曲面的拓扑特征（点之间的连接）并没有考虑到曲面的几何特征。如果要考虑到曲面的几何特征的话，将每个三角面作为一个基本的元素。通过保持每个三角面的外接圆来拟合三角面。三角面的外接圆之间要保持交角不变。这样就能

## 其他的参数化方法

基于Circle Pattern的参数化

SCP参数化

## 计算共形几何视角
